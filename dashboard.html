<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת שליטה | Horizon Control & Automation</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- MQTT.js library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #1a4b8c;
            --primary: #2563eb;
            --primary-light: #00c4cc;
            --gradient: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            --text-dark: #1a1a2e;
            --text-light: #6b7280;
            --bg-light: #f8fafc;
            --bg-dark: #e5e7eb;
            --white: #ffffff;
            --error: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Heebo', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--bg-light);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            height: 50px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-dark);
        }

        .user-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--white);
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #dcfce7;
            color: #166534;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .connection-status.connecting {
            background: #fef3c7;
            color: #92400e;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connected .status-dot {
            background: #22c55e;
        }

        .disconnected .status-dot {
            background: #ef4444;
        }

        .connecting .status-dot {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: 2px solid var(--error);
            color: var(--error);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: var(--error);
            color: var(--white);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .welcome-section {
            margin-bottom: 2rem;
        }

        .welcome-section h1 {
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .welcome-section p {
            color: var(--text-light);
        }

        /* MQTT Settings Panel */
        .mqtt-settings {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .mqtt-settings h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mqtt-settings h3 svg {
            width: 24px;
            height: 24px;
            fill: var(--primary);
        }

        .mqtt-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .mqtt-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mqtt-form label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .mqtt-form input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            transition: border-color 0.3s;
        }

        .mqtt-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .connect-btn {
            padding: 0.75rem 1.5rem;
            background: var(--gradient);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3);
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .disconnect-btn {
            padding: 0.75rem 1.5rem;
            background: var(--error);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .disconnect-btn:hover {
            background: #dc2626;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .card-header h3 {
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--white);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .toggle-label {
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            right: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--gradient);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(-28px);
        }

        /* Slider Control */
        .slider-container {
            padding: 1rem 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .slider-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .range-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.4);
        }

        /* Status Display */
        .status-display {
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 10px;
            text-align: center;
        }

        .status-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .status-unit {
            font-size: 1rem;
            color: var(--text-light);
        }

        /* Messages Panel */
        .messages-panel {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .messages-panel h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .messages-panel h3 svg {
            width: 24px;
            height: 24px;
            fill: var(--primary);
        }

        .messages-log {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #22c55e;
        }

        .message-item {
            padding: 0.25rem 0;
            border-bottom: 1px solid #333;
        }

        .message-time {
            color: #6b7280;
        }

        .message-topic {
            color: #00c4cc;
        }

        .message-payload {
            color: #f59e0b;
        }

        /* Publish Form */
        .publish-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            margin-top: 1rem;
        }

        .publish-form input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
        }

        .publish-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .publish-btn {
            padding: 0.75rem 1.5rem;
            background: var(--success);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .publish-btn:hover {
            background: #16a34a;
        }

        .publish-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Subscribe Form */
        .subscribe-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            margin-top: 1rem;
        }

        .subscribe-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .subscribe-btn:hover {
            background: #1d4ed8;
        }

        /* Footer */
        footer {
            background: var(--text-dark);
            color: var(--white);
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        footer p {
            opacity: 0.8;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .mqtt-form {
                grid-template-columns: 1fr;
            }

            .publish-form,
            .subscribe-form {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-right">
            <a href="index.html">
                <img src="logoHorizon.png" alt="Horizon Logo" class="logo">
            </a>
            <div class="user-info">
                <div class="user-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                </div>
                <span id="userName">אורח</span>
            </div>
        </div>
        <div class="top-bar-left">
            <div id="connectionStatus" class="connection-status disconnected">
                <span class="status-dot"></span>
                <span id="statusText">לא מחובר</span>
            </div>
            <button class="logout-btn" onclick="logout()">התנתקות</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="welcome-section">
            <h1>מערכת שליטה ובקרה</h1>
            <p>ברוכים הבאים למערכת הבקרה. התחבר לשרת MQTT כדי להתחיל</p>
        </div>

        <!-- MQTT Settings -->
        <div class="mqtt-settings">
            <h3>
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                הגדרות חיבור MQTT
            </h3>
            <div class="mqtt-form">
                <div class="form-group">
                    <label for="brokerUrl">כתובת Broker</label>
                    <input type="text" id="brokerUrl" placeholder="wss://broker.emqx.io:8084/mqtt" value="">
                </div>
                <div class="form-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" placeholder="horizon-client-xxx">
                </div>
                <div class="form-group">
                    <label for="mqttUsername">שם משתמש *</label>
                    <input type="text" id="mqttUsername" placeholder="backend_user" value="">
                </div>
                <div class="form-group">
                    <label for="mqttPassword">סיסמה *</label>
                    <input type="password" id="mqttPassword" placeholder="סיסמה" value="">
                </div>
                <button id="connectBtn" class="connect-btn" onclick="connectMQTT()">התחבר</button>
                <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectMQTT()" style="display:none;">התנתק</button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Light Control -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                        </div>
                        שליטה בתאורה
                    </h3>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">מצב תאורה</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="lightToggle" onchange="publishToggle('horizon/light', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-container">
                    <div class="slider-header">
                        <span>עוצמת תאורה</span>
                        <span class="slider-value" id="lightValue">50%</span>
                    </div>
                    <input type="range" class="range-slider" id="lightSlider" min="0" max="100" value="50" onchange="publishSlider('horizon/light/brightness', this.value)">
                </div>
            </div>

            <!-- AC Control -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M22 11h-4.17l3.24-3.24-1.41-1.42L15 11h-2V9l4.66-4.66-1.42-1.41L13 6.17V2h-2v4.17L7.76 2.93 6.34 4.34 11 9v2H9L4.34 6.34 2.93 7.76 6.17 11H2v2h4.17l-3.24 3.24 1.41 1.42L9 13h2v2l-4.66 4.66 1.42 1.41L11 17.83V22h2v-4.17l3.24 3.24 1.42-1.41L13 15v-2h2l4.66 4.66 1.41-1.42L17.83 13H22v-2z"/></svg>
                        </div>
                        מיזוג אוויר
                    </h3>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">מצב מיזוג</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="acToggle" onchange="publishToggle('horizon/ac', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-container">
                    <div class="slider-header">
                        <span>טמפרטורה</span>
                        <span class="slider-value" id="tempValue">24°C</span>
                    </div>
                    <input type="range" class="range-slider" id="tempSlider" min="16" max="30" value="24" onchange="publishSlider('horizon/ac/temp', this.value)">
                </div>
            </div>

            <!-- Blinds Control -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M20 19V3H4v16H2v2h20v-2h-2zM6 5h12v2H6V5zm0 4h12v2H6V9zm0 4h12v2H6v-2z"/></svg>
                        </div>
                        תריסים
                    </h3>
                </div>
                <div class="slider-container">
                    <div class="slider-header">
                        <span>מצב תריסים</span>
                        <span class="slider-value" id="blindsValue">50%</span>
                    </div>
                    <input type="range" class="range-slider" id="blindsSlider" min="0" max="100" value="50" onchange="publishSlider('horizon/blinds', this.value)">
                </div>
            </div>

            <!-- Temperature Sensor -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-8c0-.55.45-1 1-1s1 .45 1 1h-1v1h1v2h-1v1h1v2h-2V5z"/></svg>
                        </div>
                        חיישן טמפרטורה
                    </h3>
                </div>
                <div class="status-display">
                    <span class="status-value" id="sensorTemp">--</span>
                    <span class="status-unit">°C</span>
                </div>
            </div>

            <!-- Humidity Sensor -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8zm0 18c-3.35 0-6-2.57-6-6.2 0-2.34 1.95-5.44 6-9.14 4.05 3.7 6 6.79 6 9.14 0 3.63-2.65 6.2-6 6.2z"/></svg>
                        </div>
                        חיישן לחות
                    </h3>
                </div>
                <div class="status-display">
                    <span class="status-value" id="sensorHumidity">--</span>
                    <span class="status-unit">%</span>
                </div>
            </div>

            <!-- Custom Toggle -->
            <div class="control-card">
                <div class="card-header">
                    <h3>
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                        </div>
                        התקן מותאם
                    </h3>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">מצב הפעלה</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="customToggle" onchange="publishToggle('horizon/custom', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Messages Panel -->
        <div class="messages-panel">
            <h3>
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                הודעות MQTT
            </h3>

            <!-- Subscribe Form -->
            <div class="subscribe-form">
                <input type="text" id="subscribeTopic" placeholder="נושא להרשמה (לדוגמה: horizon/test)" value="horizon/test">
                <button class="subscribe-btn" onclick="subscribeTopic()" id="subscribeBtn" disabled>הרשמה</button>
            </div>

            <div class="messages-log" id="messagesLog">
                <div class="message-item">
                    <span class="message-time">[מערכת]</span> ממתין לחיבור...
                </div>
            </div>

            <!-- Publish Form -->
            <div class="publish-form">
                <input type="text" id="publishTopic" placeholder="נושא (Topic)">
                <input type="text" id="publishPayload" placeholder="הודעה (Payload)">
                <button class="publish-btn" onclick="publishMessage()" id="publishBtn" disabled>שלח</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>© 2024 Horizon Control & Automation. כל הזכויות שמורות.</p>
    </footer>

    <script>
        let mqttClient = null;

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const userSession = sessionStorage.getItem('currentUser');
            if (userSession) {
                const user = JSON.parse(userSession);
                document.getElementById('userName').textContent = user.clientName;

                // Hide MQTT panels if configured
                if (user.hideMqttPanel) {
                    document.querySelector('.mqtt-settings').style.display = 'none';
                    document.querySelector('.messages-panel').style.display = 'none';
                    // Auto-connect in background if MQTT settings exist
                    autoConnectMqtt();
                }
            }

            // Generate unique client ID
            document.getElementById('clientId').value = 'horizon-' + Math.random().toString(16).substr(2, 8);
        });

        function autoConnectMqtt() {
            // Get MQTT settings from admin data
            const adminData = localStorage.getItem('horizonAdminData');
            if (adminData) {
                const data = JSON.parse(adminData);
                if (data.mqttDefaults && data.mqttDefaults.broker && data.mqttDefaults.username) {
                    document.getElementById('brokerUrl').value = data.mqttDefaults.broker;
                    document.getElementById('mqttUsername').value = data.mqttDefaults.username;
                    document.getElementById('mqttPassword').value = data.mqttDefaults.password;
                    // Auto connect
                    setTimeout(connectMQTT, 500);
                }
            }
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
            }
            window.location.href = 'login.html';
        }

        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');

            statusEl.className = 'connection-status ' + status;
            statusText.textContent = text;

            // Enable/disable buttons based on connection
            const isConnected = status === 'connected';
            document.getElementById('publishBtn').disabled = !isConnected;
            document.getElementById('subscribeBtn').disabled = !isConnected;
            document.getElementById('connectBtn').style.display = isConnected ? 'none' : 'inline-block';
            document.getElementById('disconnectBtn').style.display = isConnected ? 'inline-block' : 'none';
        }

        function addMessage(type, topic, payload) {
            const log = document.getElementById('messagesLog');
            const time = new Date().toLocaleTimeString('he-IL');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';

            if (type === 'system') {
                messageDiv.innerHTML = `<span class="message-time">[${time}]</span> ${topic}`;
            } else {
                messageDiv.innerHTML = `
                    <span class="message-time">[${time}]</span>
                    <span class="message-topic">${topic}</span>:
                    <span class="message-payload">${payload}</span>
                `;
            }

            log.appendChild(messageDiv);
            log.scrollTop = log.scrollHeight;
        }

        function connectMQTT() {
            let brokerUrl = document.getElementById('brokerUrl').value.trim();
            const clientId = document.getElementById('clientId').value.trim();
            const username = document.getElementById('mqttUsername').value.trim();
            const password = document.getElementById('mqttPassword').value;

            // Validate required fields
            if (!brokerUrl) {
                addMessage('system', 'שגיאה: יש להזין כתובת Broker');
                return;
            }
            if (!username || !password) {
                addMessage('system', 'שגיאה: יש להזין שם משתמש וסיסמה');
                return;
            }

            // Convert protocol for browser WebSocket connection
            // EMQX Cloud: mqtts:// or mqtt:// needs to be wss:// or ws://
            if (brokerUrl.startsWith('mqtts://')) {
                brokerUrl = brokerUrl.replace('mqtts://', 'wss://');
            } else if (brokerUrl.startsWith('mqtt://')) {
                brokerUrl = brokerUrl.replace('mqtt://', 'ws://');
            } else if (!brokerUrl.startsWith('ws://') && !brokerUrl.startsWith('wss://')) {
                brokerUrl = 'wss://' + brokerUrl;
            }
            // Add /mqtt path if not present (required for WebSocket)
            if (!brokerUrl.includes('/mqtt') && !brokerUrl.endsWith('/')) {
                brokerUrl = brokerUrl + '/mqtt';
            }

            updateConnectionStatus('connecting', 'מתחבר...');
            addMessage('system', 'מנסה להתחבר ל-' + brokerUrl);
            console.log('Connecting to:', brokerUrl, 'with user:', username);

            const options = {
                clientId: clientId || 'horizon-web-' + Math.random().toString(16).substr(2, 8),
                clean: true,
                connectTimeout: 30000,
                reconnectPeriod: 5000,
                username: username,
                password: password,
                protocolVersion: 4,
                keepalive: 60,
                rejectUnauthorized: false  // Important for self-signed certificates
            };

            try {
                console.log('MQTT Options:', JSON.stringify({...options, password: '***'}));
                mqttClient = mqtt.connect(brokerUrl, options);

                mqttClient.on('connect', function() {
                    updateConnectionStatus('connected', 'מחובר');
                    addMessage('system', 'התחברות הצליחה! מחובר ל-MQTT Broker');

                    // Auto-subscribe to horizon/test topic
                    mqttClient.subscribe('horizon/test', function(err) {
                        if (!err) {
                            addMessage('system', 'נרשם לנושא: horizon/test');
                        } else {
                            addMessage('system', 'שגיאה בהרשמה ל-horizon/test: ' + err.message);
                        }
                    });
                });

                mqttClient.on('message', function(topic, message) {
                    const payload = message.toString();
                    addMessage('message', topic, payload);

                    // Try to parse JSON and update UI
                    try {
                        const data = JSON.parse(payload);
                        handleIncomingMessage(topic, payload, data);
                    } catch (e) {
                        handleIncomingMessage(topic, payload, null);
                    }
                });

                mqttClient.on('error', function(err) {
                    updateConnectionStatus('disconnected', 'שגיאת חיבור');
                    let errorMsg = err.message || 'שגיאה לא ידועה';
                    if (err.code) errorMsg += ' (קוד: ' + err.code + ')';
                    addMessage('system', 'שגיאה: ' + errorMsg);
                    console.error('MQTT Error:', err);
                });

                mqttClient.on('close', function() {
                    updateConnectionStatus('disconnected', 'התנתק');
                    addMessage('system', 'החיבור נסגר');
                    console.log('MQTT connection closed');
                });

                mqttClient.on('offline', function() {
                    updateConnectionStatus('disconnected', 'לא מקוון');
                    addMessage('system', 'החיבור לא זמין - בדוק את כתובת השרת והפורט');
                });

                mqttClient.on('reconnect', function() {
                    updateConnectionStatus('connecting', 'מתחבר מחדש...');
                    addMessage('system', 'מנסה להתחבר מחדש...');
                });

                mqttClient.on('disconnect', function(packet) {
                    updateConnectionStatus('disconnected', 'נותק');
                    addMessage('system', 'נותק מהשרת');
                    console.log('MQTT disconnected:', packet);
                });

            } catch (err) {
                updateConnectionStatus('disconnected', 'שגיאה');
                addMessage('system', 'שגיאת חיבור: ' + (err.message || err));
                console.error('Connection error:', err);
            }
        }

        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
        }

        function subscribeTopic() {
            const topic = document.getElementById('subscribeTopic').value;
            if (!topic || !mqttClient) return;

            mqttClient.subscribe(topic, function(err) {
                if (!err) {
                    addMessage('system', 'נרשם לנושא: ' + topic);
                } else {
                    addMessage('system', 'שגיאה בהרשמה: ' + err.message);
                }
            });
        }

        function publishMessage() {
            const topic = document.getElementById('publishTopic').value;
            const payload = document.getElementById('publishPayload').value;

            if (!topic || !mqttClient) return;

            mqttClient.publish(topic, payload);
            addMessage('system', 'נשלח: ' + topic + ' = ' + payload);
        }

        function publishToggle(topic, state) {
            if (!mqttClient || !mqttClient.connected) return;
            mqttClient.publish(topic, state ? 'ON' : 'OFF');
            addMessage('system', 'נשלח: ' + topic + ' = ' + (state ? 'ON' : 'OFF'));
        }

        function publishSlider(topic, value) {
            if (!mqttClient || !mqttClient.connected) return;
            mqttClient.publish(topic, value.toString());
            addMessage('system', 'נשלח: ' + topic + ' = ' + value);

            // Update display values
            if (topic.includes('brightness')) {
                document.getElementById('lightValue').textContent = value + '%';
            } else if (topic.includes('temp')) {
                document.getElementById('tempValue').textContent = value + '°C';
            } else if (topic.includes('blinds')) {
                document.getElementById('blindsValue').textContent = value + '%';
            }
        }

        function handleIncomingMessage(topic, payload, jsonData) {
            // Update UI controls based on incoming MQTT messages
            if (topic === 'horizon/light') {
                document.getElementById('lightToggle').checked = payload === 'ON';
            } else if (topic === 'horizon/light/brightness') {
                document.getElementById('lightSlider').value = payload;
                document.getElementById('lightValue').textContent = payload + '%';
            } else if (topic === 'horizon/ac') {
                document.getElementById('acToggle').checked = payload === 'ON';
            } else if (topic === 'horizon/ac/temp') {
                document.getElementById('tempSlider').value = payload;
                document.getElementById('tempValue').textContent = payload + '°C';
            } else if (topic === 'horizon/blinds') {
                document.getElementById('blindsSlider').value = payload;
                document.getElementById('blindsValue').textContent = payload + '%';
            } else if (topic === 'horizon/sensor/temperature') {
                document.getElementById('sensorTemp').textContent = payload;
            } else if (topic === 'horizon/sensor/humidity') {
                document.getElementById('sensorHumidity').textContent = payload;
            } else if (topic === 'horizon/custom') {
                document.getElementById('customToggle').checked = payload === 'ON';
            }

            // Handle JSON sensor data from horizon/test topic
            if (jsonData && topic === 'horizon/test') {
                // Example: {"sensor": "temp1", "value": 24.5}
                if (jsonData.sensor === 'temp1' || jsonData.sensor === 'temperature') {
                    document.getElementById('sensorTemp').textContent = jsonData.value;
                } else if (jsonData.sensor === 'humidity') {
                    document.getElementById('sensorHumidity').textContent = jsonData.value;
                }
            }
        }

        // Update slider displays on input
        document.getElementById('lightSlider').addEventListener('input', function() {
            document.getElementById('lightValue').textContent = this.value + '%';
        });

        document.getElementById('tempSlider').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value + '°C';
        });

        document.getElementById('blindsSlider').addEventListener('input', function() {
            document.getElementById('blindsValue').textContent = this.value + '%';
        });
    </script>
</body>
</html>
