<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק ניהול | Horizon Control & Automation</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-dark: #1a4b8c;
            --primary: #2563eb;
            --primary-light: #00c4cc;
            --gradient: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            --text-dark: #1a1a2e;
            --text-light: #6b7280;
            --bg-light: #f8fafc;
            --white: #ffffff;
            --error: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --sidebar-width: 280px;
        }
        body { font-family: 'Heebo', sans-serif; color: var(--text-dark); line-height: 1.6; background: var(--bg-light); min-height: 100vh; }
        .admin-layout { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--text-dark); color: var(--white); position: fixed; height: 100vh; overflow-y: auto; transition: transform 0.3s; z-index: 100; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 1rem; }
        .sidebar-header img { height: 40px; }
        .sidebar-header h2 { font-size: 1.1rem; font-weight: 600; }
        .sidebar-menu { padding: 1rem 0; }
        .menu-section { padding: 0.5rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.5); letter-spacing: 1px; margin-top: 1rem; }
        .menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1.5rem; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; cursor: pointer; border: none; background: none; width: 100%; font-family: 'Heebo', sans-serif; font-size: 1rem; text-align: right; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .menu-item.active { background: var(--gradient); color: var(--white); }
        .menu-item svg { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        .sidebar-footer { position: absolute; bottom: 0; width: 100%; padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .logout-btn { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: var(--error); color: var(--white); border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 1rem; width: 100%; transition: all 0.3s; }
        .logout-btn:hover { background: #dc2626; }
        .logout-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .main-content { flex: 1; margin-right: var(--sidebar-width); padding: 2rem; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title h1 { font-size: 1.75rem; color: var(--primary-dark); }
        .page-title p { color: var(--text-light); font-size: 0.9rem; }
        .admin-info { display: flex; align-items: center; gap: 1rem; background: var(--white); padding: 0.75rem 1.25rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-avatar { width: 40px; height: 40px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .admin-avatar svg { width: 24px; height: 24px; fill: var(--white); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--white); padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .stat-card h3 { font-size: 2rem; color: var(--primary-dark); }
        .stat-card p { color: var(--text-light); font-size: 0.9rem; }
        .stat-icon { width: 50px; height: 50px; background: var(--gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; }
        .stat-icon svg { width: 28px; height: 28px; fill: var(--white); }
        .content-section { display: none; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--white); border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .card-header h3 { color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
        .card-header h3 svg { width: 24px; height: 24px; fill: var(--primary); }
        .card-body { padding: 1.5rem; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        th { background: var(--bg-light); font-weight: 600; color: var(--text-dark); }
        tr:hover { background: var(--bg-light); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: inline-block; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 0.9rem; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn svg { width: 18px; height: 18px; fill: currentColor; }
        .btn-primary { background: var(--gradient); color: var(--white); box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-success:hover { background: #16a34a; }
        .btn-danger { background: var(--error); color: var(--white); }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: var(--white); }
        .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: 'Heebo', sans-serif; font-size: 1rem; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-group small { color: var(--text-light); font-size: 0.85rem; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 1rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--white); border-radius: 15px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { color: var(--primary-dark); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); transition: color 0.3s; }
        .modal-close:hover { color: var(--error); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 1rem; }
        .activity-log { max-height: 400px; overflow-y: auto; }
        .activity-item { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid #e5e7eb; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; background: var(--bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .activity-icon svg { width: 20px; height: 20px; fill: var(--primary); }
        .activity-icon.login svg { fill: var(--success); }
        .activity-icon.action svg { fill: var(--warning); }
        .activity-content h4 { font-size: 0.95rem; color: var(--text-dark); }
        .activity-content p { font-size: 0.85rem; color: var(--text-light); }
        .mobile-menu-btn { display: none; position: fixed; top: 1rem; right: 1rem; z-index: 101; background: var(--gradient); color: var(--white); border: none; padding: 0.75rem; border-radius: 10px; cursor: pointer; }
        .mobile-menu-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .toast-container { position: fixed; top: 1rem; left: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--white); padding: 1rem 1.5rem; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 0.75rem; animation: toastSlide 0.3s ease; }
        @keyframes toastSlide { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-right: 4px solid var(--success); }
        .toast.error { border-right: 4px solid var(--error); }
        .toast svg { width: 24px; height: 24px; }
        .toast.success svg { fill: var(--success); }
        .toast.error svg { fill: var(--error); }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; }
            .mobile-menu-btn { display: block; }
        }
        @media (max-width: 576px) {
            .main-content { padding: 1rem; padding-top: 4rem; }
            .top-bar { flex-direction: column; align-items: flex-start; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>
    <div class="toast-container" id="toastContainer"></div>

    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="logoHorizon.png" alt="Horizon">
                <h2>ממשק ניהול</h2>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-section">ראשי</div>
                <button class="menu-item active" onclick="showSection('dashboard')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    לוח בקרה
                </button>
                <div class="menu-section">ניהול</div>
                <button class="menu-item" onclick="showSection('users')">
                    <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    ניהול משתמשים
                </button>
                <button class="menu-item" onclick="showSection('permissions')">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                    הרשאות והפניות
                </button>
                <button class="menu-item" onclick="showSection('devices')">
                    <svg viewBox="0 0 24 24"><path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2z"/></svg>
                    ניהול התקנים
                </button>
                <div class="menu-section">הגדרות</div>
                <button class="menu-item" onclick="showSection('mqtt')">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                    הגדרות MQTT
                </button>
                <button class="menu-item" onclick="showSection('logs')">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>
                    לוג פעילות
                </button>
                <button class="menu-item" onclick="showSection('admin-settings')">
                    <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    הגדרות מנהל
                </button>
            </nav>
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    התנתקות
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="page-title">
                    <h1 id="pageTitle">לוח בקרה</h1>
                    <p id="pageSubtitle">ברוך הבא לממשק הניהול</p>
                </div>
                <div class="admin-info">
                    <div class="admin-avatar">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                    </div>
                    <span id="adminName">מנהל מערכת</span>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="section-dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3z"/></svg></div>
                        <h3 id="totalUsers">0</h3>
                        <p>משתמשים רשומים</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
                        <h3 id="activeUsers">0</h3>
                        <p>משתמשים פעילים</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><svg viewBox="0 0 24 24"><path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2z"/></svg></div>
                        <h3 id="totalDevices">6</h3>
                        <p>התקנים מוגדרים</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><svg viewBox="0 0 24 24"><path d="M11 17c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1z"/></svg></div>
                        <h3 id="todayLogins">0</h3>
                        <p>כניסות היום</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>פעילות אחרונה</h3></div>
                    <div class="card-body"><div class="activity-log" id="recentActivity"></div></div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="section-users" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h3><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/></svg>רשימת משתמשים</h3>
                        <button class="btn btn-primary" onclick="openUserModal()">
                            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            הוסף משתמש
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>שם משתמש</th><th>שם לקוח</th><th>דף Dashboard</th><th>סטטוס</th><th>כניסה אחרונה</th><th>פעולות</th></tr></thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Permissions Section -->
            <section id="section-permissions" class="content-section">
                <div class="card">
                    <div class="card-header"><h3><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>הרשאות משתמשים</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="selectUserPerm">בחר משתמש:</label>
                            <select id="selectUserPerm" onchange="loadUserPermissions()"><option value="">-- בחר משתמש --</option></select>
                        </div>
                        <div id="permissionsForm" style="display: none;">
                            <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark);">פקדים מותרים:</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" id="perm_light" value="light">שליטה בתאורה</label>
                                <label class="checkbox-item"><input type="checkbox" id="perm_ac" value="ac">מיזוג אוויר</label>
                                <label class="checkbox-item"><input type="checkbox" id="perm_blinds" value="blinds">תריסים</label>
                                <label class="checkbox-item"><input type="checkbox" id="perm_sensors" value="sensors">חיישנים</label>
                                <label class="checkbox-item"><input type="checkbox" id="perm_custom" value="custom">התקן מותאם</label>
                            </div>
                            <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-dark);">Topics מותרים ב-MQTT:</h4>
                            <div class="form-group">
                                <textarea id="allowedTopics" rows="4" placeholder="הזן topics מופרדים בשורות חדשות"></textarea>
                            </div>
                            <button class="btn btn-success" onclick="savePermissions()"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>שמור הרשאות</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Devices Section -->
            <section id="section-devices" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h3><svg viewBox="0 0 24 24"><path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2z"/></svg>התקנים זמינים</h3>
                        <button class="btn btn-primary" onclick="openDeviceModal()"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>הוסף התקן</button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>שם התקן</th><th>סוג</th><th>Topic</th><th>סטטוס</th><th>פעולות</th></tr></thead>
                                <tbody id="devicesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MQTT Settings Section -->
            <section id="section-mqtt" class="content-section">
                <div class="card">
                    <div class="card-header"><h3><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>הגדרות MQTT ברירת מחדל</h3></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group"><label for="defaultBroker">כתובת Broker</label><input type="text" id="defaultBroker" value="wss://broker.hivemq.com:8884/mqtt"></div>
                            <div class="form-group"><label for="baseTopic">Topic בסיסי</label><input type="text" id="baseTopic" value="horizon"></div>
                        </div>
                        <button class="btn btn-success" onclick="saveMqttSettings()"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>שמור הגדרות</button>
                    </div>
                </div>
            </section>

            <!-- Logs Section -->
            <section id="section-logs" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h3><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>לוג פעילות מערכת</h3>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="filterLogs('all')">הכל</button>
                            <button class="btn btn-outline btn-sm" onclick="filterLogs('login')">כניסות</button>
                            <button class="btn btn-outline btn-sm" onclick="filterLogs('action')">פעולות</button>
                        </div>
                    </div>
                    <div class="card-body"><div class="activity-log" id="fullActivityLog"></div></div>
                </div>
            </section>

            <!-- Admin Settings Section -->
            <section id="section-admin-settings" class="content-section">
                <div class="card">
                    <div class="card-header"><h3><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"/></svg>שינוי פרטי מנהל</h3></div>
                    <div class="card-body">
                        <p style="margin-bottom: 1.5rem; color: var(--text-light);">שנה את שם המשתמש והסיסמה של חשבון המנהל</p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="adminUsername">שם משתמש מנהל</label>
                                <input type="text" id="adminUsername" placeholder="שם משתמש">
                            </div>
                            <div class="form-group">
                                <label for="adminCurrentPassword">סיסמה נוכחית</label>
                                <input type="password" id="adminCurrentPassword" placeholder="הזן סיסמה נוכחית">
                            </div>
                            <div class="form-group">
                                <label for="adminNewPassword">סיסמה חדשה</label>
                                <input type="password" id="adminNewPassword" placeholder="הזן סיסמה חדשה">
                            </div>
                            <div class="form-group">
                                <label for="adminConfirmPassword">אימות סיסמה חדשה</label>
                                <input type="password" id="adminConfirmPassword" placeholder="הזן שוב את הסיסמה החדשה">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveAdminSettings()">
                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            שמור שינויים
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="userModalTitle">הוסף משתמש חדש</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-grid">
                    <div class="form-group"><label for="newUsername">שם משתמש *</label><input type="text" id="newUsername" required></div>
                    <div class="form-group"><label for="newPassword">סיסמה *</label><input type="password" id="newPassword" required></div>
                    <div class="form-group"><label for="newClientName">שם הלקוח לתצוגה *</label><input type="text" id="newClientName" required></div>
                    <div class="form-group"><label for="newDashboard">דף Dashboard</label><select id="newDashboard"><option value="dashboard.html">dashboard.html (ברירת מחדל)</option></select></div>
                </div>
                <div class="form-group"><label><input type="checkbox" id="newUserActive" checked> משתמש פעיל</label></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeUserModal()">ביטול</button>
                <button class="btn btn-primary" onclick="saveUser()">שמור</button>
            </div>
        </div>
    </div>

    <!-- Device Modal -->
    <div class="modal-overlay" id="deviceModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="deviceModalTitle">הוסף התקן חדש</h3>
                <button class="modal-close" onclick="closeDeviceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDeviceId">
                <div class="form-grid">
                    <div class="form-group"><label for="deviceName">שם התקן *</label><input type="text" id="deviceName" required></div>
                    <div class="form-group"><label for="deviceType">סוג התקן *</label><select id="deviceType"><option value="toggle">מתג (הפעלה/כיבוי)</option><option value="slider">מחוון (0-100)</option><option value="sensor">חיישן (קריאה בלבד)</option></select></div>
                    <div class="form-group"><label for="deviceTopic">Topic ב-MQTT *</label><input type="text" id="deviceTopic" placeholder="horizon/device_name"></div>
                </div>
                <div class="form-group"><label><input type="checkbox" id="deviceActive" checked> התקן פעיל</label></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeDeviceModal()">ביטול</button>
                <button class="btn btn-primary" onclick="saveDevice()">שמור</button>
            </div>
        </div>
    </div>

    <script>
        let adminData = {
            users: {
                'demo': { password: 'demo123', clientName: 'לקוח דמו', dashboardPage: 'dashboard.html', active: true, lastLogin: null, permissions: { controls: ['light', 'ac', 'blinds', 'sensors'], topics: ['horizon/#'] } },
                'client1': { password: 'client123', clientName: 'לקוח 1', dashboardPage: 'dashboard.html', active: true, lastLogin: null, permissions: { controls: ['light', 'ac'], topics: ['horizon/light/#', 'horizon/ac/#'] } }
            },
            devices: [
                { id: 1, name: 'תאורה ראשית', type: 'toggle', topic: 'horizon/light', active: true },
                { id: 2, name: 'עוצמת תאורה', type: 'slider', topic: 'horizon/light/brightness', active: true },
                { id: 3, name: 'מיזוג אוויר', type: 'toggle', topic: 'horizon/ac', active: true },
                { id: 4, name: 'טמפרטורת מיזוג', type: 'slider', topic: 'horizon/ac/temp', active: true },
                { id: 5, name: 'תריסים', type: 'slider', topic: 'horizon/blinds', active: true },
                { id: 6, name: 'חיישן טמפרטורה', type: 'sensor', topic: 'horizon/sensor/temperature', active: true }
            ],
            mqttDefaults: { broker: 'wss://broker.hivemq.com:8884/mqtt', baseTopic: 'horizon' },
            activityLog: [],
            adminCredentials: { username: 'admin', password: 'admin123' }
        };

        const savedData = localStorage.getItem('horizonAdminData');
        if (savedData) adminData = JSON.parse(savedData);
        if (!adminData.adminCredentials) adminData.adminCredentials = { username: 'admin', password: 'admin123' };

        function saveData() { localStorage.setItem('horizonAdminData', JSON.stringify(adminData)); }

        document.addEventListener('DOMContentLoaded', function() {
            const adminSession = sessionStorage.getItem('adminUser');
            if (!adminSession) { window.location.href = 'login.html'; return; }
            initializeDashboard();
            document.getElementById('adminUsername').value = adminData.adminCredentials.username;
        });

        function initializeDashboard() {
            updateStats();
            renderUsersTable();
            renderDevicesTable();
            renderActivityLog();
            populateUserSelects();
        }

        function updateStats() {
            const users = Object.keys(adminData.users);
            const activeUsers = users.filter(u => adminData.users[u].active);
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = activeUsers.length;
            document.getElementById('totalDevices').textContent = adminData.devices.length;
            document.getElementById('todayLogins').textContent = adminData.activityLog.filter(a => a.type === 'login').length;
        }

        function showSection(section) {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + section).classList.add('active');
            const titles = {
                'dashboard': { title: 'לוח בקרה', subtitle: 'סקירה כללית של המערכת' },
                'users': { title: 'ניהול משתמשים', subtitle: 'הוספה, עריכה ומחיקה של משתמשים' },
                'permissions': { title: 'הרשאות והפניות', subtitle: 'ניהול הרשאות גישה למשתמשים' },
                'devices': { title: 'ניהול התקנים', subtitle: 'הגדרת התקנים ופקדים' },
                'mqtt': { title: 'הגדרות MQTT', subtitle: 'תצורת חיבור ל-Broker' },
                'logs': { title: 'לוג פעילות', subtitle: 'מעקב אחר פעולות במערכת' },
                'admin-settings': { title: 'הגדרות מנהל', subtitle: 'שינוי פרטי התחברות מנהל' }
            };
            document.getElementById('pageTitle').textContent = titles[section].title;
            document.getElementById('pageSubtitle').textContent = titles[section].subtitle;
            document.getElementById('sidebar').classList.remove('active');
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            Object.keys(adminData.users).forEach(username => {
                const user = adminData.users[username];
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + username + '</strong></td><td>' + user.clientName + '</td><td>' + user.dashboardPage + '</td><td><span class="badge ' + (user.active ? 'badge-success' : 'badge-error') + '">' + (user.active ? 'פעיל' : 'לא פעיל') + '</span></td><td>' + (user.lastLogin || 'לא התחבר') + '</td><td><div class="action-btns"><button class="btn btn-outline btn-sm" onclick="editUser(\'' + username + '\')">עריכה</button><button class="btn btn-danger btn-sm" onclick="deleteUser(\'' + username + '\')">מחיקה</button></div></td>';
                tbody.appendChild(row);
            });
        }

        function openUserModal(username) {
            document.getElementById('userModal').classList.add('active');
            document.getElementById('userModalTitle').textContent = username ? 'עריכת משתמש' : 'הוסף משתמש חדש';
            if (username) {
                const user = adminData.users[username];
                document.getElementById('editUserId').value = username;
                document.getElementById('newUsername').value = username;
                document.getElementById('newUsername').disabled = true;
                document.getElementById('newPassword').value = user.password;
                document.getElementById('newClientName').value = user.clientName;
                document.getElementById('newDashboard').value = user.dashboardPage;
                document.getElementById('newUserActive').checked = user.active;
            } else {
                document.getElementById('editUserId').value = '';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUsername').disabled = false;
                document.getElementById('newPassword').value = '';
                document.getElementById('newClientName').value = '';
                document.getElementById('newDashboard').value = 'dashboard.html';
                document.getElementById('newUserActive').checked = true;
            }
        }

        function closeUserModal() { document.getElementById('userModal').classList.remove('active'); }
        function editUser(username) { openUserModal(username); }

        function saveUser() {
            const editId = document.getElementById('editUserId').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const clientName = document.getElementById('newClientName').value.trim();
            const dashboardPage = document.getElementById('newDashboard').value;
            const active = document.getElementById('newUserActive').checked;
            if (!username || !password || !clientName) { showToast('error', 'יש למלא את כל השדות החובה'); return; }
            if (!editId && adminData.users[username]) { showToast('error', 'שם משתמש כבר קיים'); return; }
            adminData.users[username] = {
                password: password, clientName: clientName, dashboardPage: dashboardPage, active: active,
                lastLogin: editId ? adminData.users[username]?.lastLogin : null,
                permissions: editId ? adminData.users[username]?.permissions : { controls: [], topics: [] }
            };
            saveData(); renderUsersTable(); populateUserSelects(); updateStats(); closeUserModal();
            addActivityLog('action', 'admin', editId ? 'עדכן משתמש: ' + username : 'הוסיף משתמש: ' + username);
            showToast('success', editId ? 'המשתמש עודכן בהצלחה' : 'המשתמש נוסף בהצלחה');
        }

        function deleteUser(username) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את המשתמש "' + username + '"?')) return;
            delete adminData.users[username];
            saveData(); renderUsersTable(); populateUserSelects(); updateStats();
            addActivityLog('action', 'admin', 'מחק משתמש: ' + username);
            showToast('success', 'המשתמש נמחק בהצלחה');
        }

        function renderDevicesTable() {
            const tbody = document.getElementById('devicesTable');
            tbody.innerHTML = '';
            const typeNames = { toggle: 'מתג', slider: 'מחוון', sensor: 'חיישן' };
            adminData.devices.forEach(device => {
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + device.name + '</strong></td><td>' + typeNames[device.type] + '</td><td><code>' + device.topic + '</code></td><td><span class="badge ' + (device.active ? 'badge-success' : 'badge-error') + '">' + (device.active ? 'פעיל' : 'לא פעיל') + '</span></td><td><div class="action-btns"><button class="btn btn-outline btn-sm" onclick="editDevice(' + device.id + ')">עריכה</button><button class="btn btn-danger btn-sm" onclick="deleteDevice(' + device.id + ')">מחיקה</button></div></td>';
                tbody.appendChild(row);
            });
        }

        function openDeviceModal(deviceId) {
            document.getElementById('deviceModal').classList.add('active');
            document.getElementById('deviceModalTitle').textContent = deviceId ? 'עריכת התקן' : 'הוסף התקן חדש';
            if (deviceId) {
                const device = adminData.devices.find(d => d.id === deviceId);
                document.getElementById('editDeviceId').value = deviceId;
                document.getElementById('deviceName').value = device.name;
                document.getElementById('deviceType').value = device.type;
                document.getElementById('deviceTopic').value = device.topic;
                document.getElementById('deviceActive').checked = device.active;
            } else {
                document.getElementById('editDeviceId').value = '';
                document.getElementById('deviceName').value = '';
                document.getElementById('deviceType').value = 'toggle';
                document.getElementById('deviceTopic').value = '';
                document.getElementById('deviceActive').checked = true;
            }
        }

        function closeDeviceModal() { document.getElementById('deviceModal').classList.remove('active'); }
        function editDevice(deviceId) { openDeviceModal(deviceId); }

        function saveDevice() {
            const editId = document.getElementById('editDeviceId').value;
            const name = document.getElementById('deviceName').value.trim();
            const type = document.getElementById('deviceType').value;
            const topic = document.getElementById('deviceTopic').value.trim();
            const active = document.getElementById('deviceActive').checked;
            if (!name || !topic) { showToast('error', 'יש למלא את כל השדות החובה'); return; }
            if (editId) {
                const device = adminData.devices.find(d => d.id === parseInt(editId));
                device.name = name; device.type = type; device.topic = topic; device.active = active;
            } else {
                const newId = Math.max(...adminData.devices.map(d => d.id), 0) + 1;
                adminData.devices.push({ id: newId, name, type, topic, active });
            }
            saveData(); renderDevicesTable(); updateStats(); closeDeviceModal();
            showToast('success', editId ? 'ההתקן עודכן בהצלחה' : 'ההתקן נוסף בהצלחה');
        }

        function deleteDevice(deviceId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק התקן זה?')) return;
            adminData.devices = adminData.devices.filter(d => d.id !== deviceId);
            saveData(); renderDevicesTable(); updateStats();
            showToast('success', 'ההתקן נמחק בהצלחה');
        }

        function populateUserSelects() {
            const select = document.getElementById('selectUserPerm');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- בחר משתמש --</option>';
            Object.keys(adminData.users).forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = adminData.users[username].clientName + ' (' + username + ')';
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        function loadUserPermissions() {
            const username = document.getElementById('selectUserPerm').value;
            const form = document.getElementById('permissionsForm');
            if (!username) { form.style.display = 'none'; return; }
            form.style.display = 'block';
            const user = adminData.users[username];
            const permissions = user.permissions || { controls: [], topics: [] };
            ['light', 'ac', 'blinds', 'sensors', 'custom'].forEach(control => {
                document.getElementById('perm_' + control).checked = permissions.controls.includes(control);
            });
            document.getElementById('allowedTopics').value = permissions.topics.join('\n');
        }

        function savePermissions() {
            const username = document.getElementById('selectUserPerm').value;
            if (!username) return;
            const controls = [];
            ['light', 'ac', 'blinds', 'sensors', 'custom'].forEach(control => {
                if (document.getElementById('perm_' + control).checked) controls.push(control);
            });
            const topicsText = document.getElementById('allowedTopics').value;
            const topics = topicsText.split('\n').map(t => t.trim()).filter(t => t);
            adminData.users[username].permissions = { controls, topics };
            saveData();
            addActivityLog('action', 'admin', 'עדכן הרשאות עבור ' + username);
            showToast('success', 'ההרשאות נשמרו בהצלחה');
        }

        function saveMqttSettings() {
            adminData.mqttDefaults = {
                broker: document.getElementById('defaultBroker').value,
                baseTopic: document.getElementById('baseTopic').value
            };
            saveData();
            showToast('success', 'הגדרות MQTT נשמרו בהצלחה');
        }

        function saveAdminSettings() {
            const username = document.getElementById('adminUsername').value.trim();
            const currentPassword = document.getElementById('adminCurrentPassword').value;
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;

            if (!username) { showToast('error', 'יש להזין שם משתמש'); return; }
            if (currentPassword !== adminData.adminCredentials.password) { showToast('error', 'הסיסמה הנוכחית שגויה'); return; }
            if (newPassword && newPassword !== confirmPassword) { showToast('error', 'הסיסמאות החדשות אינן תואמות'); return; }

            adminData.adminCredentials.username = username;
            if (newPassword) adminData.adminCredentials.password = newPassword;
            saveData();

            document.getElementById('adminCurrentPassword').value = '';
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';

            addActivityLog('action', 'admin', 'עדכן פרטי מנהל');
            showToast('success', 'פרטי המנהל עודכנו בהצלחה');
        }

        function addActivityLog(type, user, action) {
            const now = new Date();
            const time = now.toLocaleString('he-IL');
            adminData.activityLog.unshift({ type, user, action, time });
            if (adminData.activityLog.length > 100) adminData.activityLog = adminData.activityLog.slice(0, 100);
            saveData();
            renderActivityLog();
        }

        function renderActivityLog() {
            const recentLog = document.getElementById('recentActivity');
            const fullLog = document.getElementById('fullActivityLog');
            const renderItems = (container, items) => {
                container.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.innerHTML = '<div class="activity-icon ' + item.type + '"><svg viewBox="0 0 24 24">' + (item.type === 'login' ? '<path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5z"/>' : '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>') + '</svg></div><div class="activity-content"><h4>' + item.action + '</h4><p>' + item.user + ' - ' + item.time + '</p></div>';
                    container.appendChild(div);
                });
            };
            renderItems(recentLog, adminData.activityLog.slice(0, 5));
            renderItems(fullLog, adminData.activityLog);
        }

        function filterLogs(type) {
            const items = type === 'all' ? adminData.activityLog : adminData.activityLog.filter(a => a.type === type);
            const container = document.getElementById('fullActivityLog');
            container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.innerHTML = '<div class="activity-icon ' + item.type + '"><svg viewBox="0 0 24 24">' + (item.type === 'login' ? '<path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5z"/>' : '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>') + '</svg></div><div class="activity-content"><h4>' + item.action + '</h4><p>' + item.user + ' - ' + item.time + '</p></div>';
                container.appendChild(div);
            });
        }

        function showToast(type, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<svg viewBox="0 0 24 24">' + (type === 'success' ? '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>' : '<path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>') + '</svg><span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function logout() { sessionStorage.removeItem('adminUser'); window.location.href = 'login.html'; }
    </script>
</body>
</html>
